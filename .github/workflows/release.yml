name: Release Desktop App

on:
  push:
    tags:
      - "v*" # Trigger on version tags like v1.0.0, v1.0.0-beta.1
  workflow_dispatch:
    inputs:
      version:
        description: "Version to release (e.g., 1.0.0)"
        required: true
        type: string
      prerelease:
        description: "Is this a pre-release?"
        required: false
        type: boolean
        default: false

env:
  NODE_VERSION: "20"
  PNPM_VERSION: "8"

jobs:
  # Create GitHub Release
  create-release:
    name: Create Release
    runs-on: ubuntu-latest
    outputs:
      release_id: ${{ steps.create_release.outputs.id }}
      version: ${{ steps.get_version.outputs.version }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Get version from tag or input
        id: get_version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "version=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
          fi

      - name: Create Release
        id: create_release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.get_version.outputs.version }}
          name: DBView Desktop v${{ steps.get_version.outputs.version }}
          draft: true
          prerelease: ${{ github.event.inputs.prerelease || contains(steps.get_version.outputs.version, '-') }}
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Build for each platform
  build:
    name: Build (${{ matrix.os }})
    needs: create-release
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: macos-latest
            platform: mac
            arch: universal
          - os: ubuntu-latest
            platform: linux
            arch: x64
          - os: windows-latest
            platform: win
            arch: x64

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      # Update version in package.json
      - name: Update version
        run: |
          cd apps/desktop
          npm version ${{ needs.create-release.outputs.version }} --no-git-tag-version --allow-same-version

      - name: Build packages
        run: |
          pnpm --filter @dbview/types build
          pnpm --filter @dbview/adapters build
          pnpm --filter @dbview/desktop-ui build
          pnpm --filter @dbview/desktop build

      # macOS: Build and sign
      - name: Build macOS app
        if: matrix.platform == 'mac'
        working-directory: apps/desktop
        run: |
          pnpm exec electron-builder --mac --universal --publish never
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          # Code signing (optional - add these secrets for signed builds)
          # CSC_LINK: ${{ secrets.MAC_CERTIFICATE }}
          # CSC_KEY_PASSWORD: ${{ secrets.MAC_CERTIFICATE_PASSWORD }}
          # APPLE_ID: ${{ secrets.APPLE_ID }}
          # APPLE_APP_SPECIFIC_PASSWORD: ${{ secrets.APPLE_APP_SPECIFIC_PASSWORD }}
          # APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}

      # Linux: Build
      - name: Build Linux app
        if: matrix.platform == 'linux'
        working-directory: apps/desktop
        run: |
          pnpm exec electron-builder --linux --publish never

      # Windows: Build and sign
      - name: Build Windows app
        if: matrix.platform == 'win'
        working-directory: apps/desktop
        run: |
          pnpm exec electron-builder --win --publish never
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          # Code signing (optional - add these secrets for signed builds)
          # CSC_LINK: ${{ secrets.WIN_CERTIFICATE }}
          # CSC_KEY_PASSWORD: ${{ secrets.WIN_CERTIFICATE_PASSWORD }}

      # Upload to release
      - name: Upload macOS artifacts to release
        if: matrix.platform == 'mac'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ needs.create-release.outputs.version }}
          files: |
            apps/desktop/release/*.dmg
            apps/desktop/release/*.zip
            apps/desktop/release/latest-mac.yml
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload Linux artifacts to release
        if: matrix.platform == 'linux'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ needs.create-release.outputs.version }}
          files: |
            apps/desktop/release/*.AppImage
            apps/desktop/release/*.deb
            apps/desktop/release/latest-linux.yml
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload Windows artifacts to release
        if: matrix.platform == 'win'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ needs.create-release.outputs.version }}
          files: |
            apps/desktop/release/*.exe
            apps/desktop/release/latest.yml
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Publish the release (make it non-draft)
  publish-release:
    name: Publish Release
    needs: [create-release, build]
    runs-on: ubuntu-latest
    steps:
      - name: Publish release
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.repos.updateRelease({
              owner: context.repo.owner,
              repo: context.repo.repo,
              release_id: ${{ needs.create-release.outputs.release_id }},
              draft: false
            });
